name: ui-tests

on:
  workflow_run:
    workflows: ["Notify ui test"]
    types:
      - completed

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: bansan85/action-workflow_run-status@main

      - name: checkout
        uses: actions/checkout@v2

      - name: cached dependencies
        uses: actions/cache@v2
        id: cached-dependencies
        with:
          path: |
            ./vendor
            ./tawkto/vendor
          # the key will change if composer.lock changes
          key: ${{ runner.os }}-composer-dependencies-${{ hashFiles('**/composer.lock') }}

      - name: install dependencies
        if: steps.cached-dependencies.outputs.cache-hit != 'true'
        uses: php-actions/composer@v6
        with:
          php_extensions: zip
          command: run build

  tests:
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        browser: ['chrome', 'firefox', 'edge']

    runs-on: ubuntu-latest
    env:
      WORDPRESS_HOST: wordpress
      BROWSER: ${{ matrix.browser }}
      SELENIUM_HOSTNAME: localhost
      SELENIUM_PORT: 4444

    steps:
      - name: Report to PR
        env:
          MATRIX_CONTEXT: ${{ toJSON(matrix) }}
        uses: bansan85/action-workflow_run-status@main

      - name: checkout
        uses: actions/checkout@v2

      - name: Start docker services and setup WordPress
        run: |
          docker-compose -f ./.github/docker/docker-compose.yml up -d;
          docker logs -f wordpress-cli;

      - name: cached dependencies
        uses: actions/cache@v2
        id: cached-dependencies
        with:
          path: |
            ./vendor
            ./tawkto/vendor
          # the key will change if composer.lock changes
          key: ${{ runner.os }}-composer-dependencies-${{ hashFiles('**/composer.lock') }}

      - name: prepare test artifact
        run: zip -9 -rq tawkto-live-chat.zip tawkto

      - name: run tests
        env:
          TAWK_PROPERTY_ID: ${{ secrets.TAWK_PROPERTY_ID }}
          TAWK_WIDGET_ID: ${{ secrets.TAWK_WIDGET_ID }}
          TAWK_USERNAME: ${{ secrets.TAWK_USERNAME }}
          TAWK_PASSWORD: ${{ secrets.TAWK_PASSWORD }}
          WEB_HOST: ${{ env.WORDPRESS_HOSTNAME }}
          SELENIUM_BROWSER: ${{ matrix.browser }}
          SELENIUM_HOST: ${{ env.SELENIUM_HOSTNAME }}
          SELENIUM_PORT: ${{ env.SELENIUM_PORT }}
        run: composer run test
